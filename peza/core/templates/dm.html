
{% load static %}
<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Chat with {{ other_user.username }} - Safety App</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.cdnfonts.com/css/maria-2" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/emoji-picker-element/index.js" type="module"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#000000',
            secondary: '#FFFFFF',
            accent: '#AAAAAA',
            surface: '#000000',
            'surface-light': '#1A1A1A',
            'text-primary': '#FFFFFF',
            'text-secondary': '#CCCCCC',
            'border-light': '#333333',
          }
        }
      }
    }
  </script>
  <style>
    :root {
      --primary: #000000;
      --secondary: #FFFFFF;
      --accent: #AAAAAA;
      --surface: #000000;
      --surface-light: #1A1A1A;
      --text-primary: #FFFFFF;
      --text-secondary: #CCCCCC;
      --border-light: #333333;
      --radius: 10px;
      --shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
    }
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Maria', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--surface);
      margin: 0;
      font-size: 10px;
      overflow: hidden;
      height: 100vh;
      transition: background 0.3s ease;
    }
    body.light {
      --primary: #FFFFFF;
      --secondary: #000000;
      --accent: #666666;
      --surface: #F5F5F7;
      --surface-light: #FFFFFF;
      --text-primary: #000000;
      --text-secondary: #666666;
      --border-light: #E5E5E7;
      background: var(--surface);
    }
    #app-container {
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: transparent;
      overflow: hidden;
    }
    .chat-container {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 140px);
      overflow-y: auto;
    }
    .chat-message {
      max-width: 70%;
      padding: 8px 12px;
      border-radius: 12px;
      margin: 4px 8px;
      font-size: 10px;
    }
    .sent {
      align-self: flex-end;
      background: var(--secondary);
      color: var(--primary);
    }
    .received {
      align-self: flex-start;
      background: var(--surface-light);
      color: var(--text-primary);
    }
    .message-time {
      font-size: 8px;
      color: var(--text-secondary);
      margin-top: 2px;
    }
    .chat-form {
      position: fixed;
      bottom: 70px;
      left: 0;
      right: 0;
      padding: 8px;
      background: var(--surface);
      border-top: 1px solid var(--border-light);
      display: flex;
      gap: 8px;
    }
    .chat-input {
      flex: 1;
      background: var(--surface-light);
      border: 1px solid var(--border-light);
      border-radius: 20px;
      padding: 8px 16px;
      color: var(--text-primary);
      font-size: 10px;
    }
    .send-btn {
      background: var(--secondary);
      color: var(--primary);
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .typing-indicator {
      font-size: 8px;
      color: var(--text-secondary);
      margin: 4px 8px;
      display: none;
    }
    .emoji-button {
      cursor: pointer;
      font-size: 16px;
    }
    emoji-picker {
      position: absolute;
      bottom: 60px;
      right: 10px;
      z-index: 100;
      display: none;
      --background: var(--surface-light);
      --border-color: var(--border-light);
      --color: var(--text-primary);
    }
    @media (max-width: 480px) {
      body { font-size: 8px; }
      .chat-message { font-size: 8px; }
      .message-time { font-size: 7px; }
      .chat-input { font-size: 8px; }
      .send-btn { width: 32px; height: 32px; }
      .emoji-button { font-size: 14px; }
      .typing-indicator { font-size: 7px; }
      .header-title { font-size: 12px; }
      .header-desc { font-size: 8px; }
    }
  </style>
</head>
<body>
  <div id="app-container">
    <!-- Header -->
    <div class="px-4 pt-4 pb-3">
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center space-x-2">
          <a href="{% url 'inbox' %}" class="p-1.5 rounded-full bg-white/10">
            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
          </a>
          <div>
            <h2 class="header-title text-sm font-semibold text-white">{{ other_user.username }}</h2>
            <p class="header-desc text-8px text-gray-400">Direct Message</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Theme Toggle -->
    <div class="theme-toggle" onclick="toggleTheme()">
      <svg id="theme-icon" class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
      </svg>
    </div>

    <!-- Chat Content -->
    <div class="chat-container content" id="chat-container">
      {% for msg in messages %}
        <div class="chat-message {% if msg.sender == request.user %}sent{% else %}received{% endif %}">
          {{ msg.content }}
          <div class="message-time">{{ msg.timestamp|timesince }} ago</div>
        </div>
      {% endfor %}
      <div id="typing-indicator" class="typing-indicator"></div>
    </div>

    <!-- Send Form -->
    <div class="chat-form">
      <span class="emoji-button" id="emoji-button">ðŸ˜€</span>
      <input type="text" id="chat-input" class="chat-input" placeholder="Type a message..." autocomplete="off">
      <button type="button" id="send-btn" class="send-btn">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
        </svg>
      </button>
    </div>
    <emoji-picker id="emoji-picker"></emoji-picker>

    <!-- Bottom Navigation -->
    {% include 'bottom_nav.html' %}
  </div>

  <script>
    // Theme toggle
    function toggleTheme() {
      const body = document.body;
      const themeIcon = document.getElementById('theme-icon');
      
      if (body.classList.contains('light')) {
        body.classList.remove('light');
        themeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />';
      } else {
        body.classList.add('light');
        themeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />';
      }
    }

    // AJAX polling for messages and typing status
    const otherUserId = '{{ other_user.id }}';
    let lastMessageId = {{ last_message_id }};
    let isTyping = false;
    let typingTimeout = null;

    function fetchMessages() {
      fetch(`/api/messages/${otherUserId}/?last_id=${lastMessageId}`, {
        headers: {
          'X-CSRFToken': '{{ csrf_token }}'
        }
      })
      .then(response => response.json())
      .then(messages => {
        const chatContainer = document.getElementById('chat-container');
        messages.forEach(msg => {
          const isSent = msg.sender === {{ request.user.id }};
          const messageElement = document.createElement('div');
          messageElement.classList.add('chat-message', isSent ? 'sent' : 'received');
          messageElement.innerHTML = `
            ${msg.content}
            <div class="message-time">just now</div>
          `;
          chatContainer.insertBefore(messageElement, document.getElementById('typing-indicator'));
          lastMessageId = Math.max(lastMessageId, msg.id);
        });
        chatContainer.scrollTop = chatContainer.scrollHeight;
      })
      .catch(error => console.error('Error fetching messages:', error));
    }

    function fetchTypingStatus() {
      fetch(`/api/typing/${otherUserId}/`)
      .then(response => response.json())
      .then(data => {
        const typingIndicator = document.getElementById('typing-indicator');
        if (data.is_typing) {
          typingIndicator.textContent = '{{ other_user.username }} is typing...';
          typingIndicator.style.display = 'block';
        } else {
          typingIndicator.style.display = 'none';
        }
      })
      .catch(error => console.error('Error fetching typing status:', error));
    }

    // Poll every 5 seconds
    setInterval(fetchMessages, 5000);
    setInterval(fetchTypingStatus, 2000);

    // Send message
    document.getElementById('send-btn').addEventListener('click', function() {
      const chatInput = document.getElementById('chat-input');
      const message = chatInput.value;
      if (message) {
        fetch(`/api/messages/${otherUserId}/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
          },
          body: JSON.stringify({ content: message })
        })
        .then(response => response.json())
        .then(data => {
          const messageElement = document.createElement('div');
          messageElement.classList.add('chat-message', 'sent');
          messageElement.innerHTML = `
            ${data.content}
            <div class="message-time">just now</div>
          `;
          document.getElementById('chat-container').insertBefore(messageElement, document.getElementById('typing-indicator'));
          lastMessageId = data.id;
          chatInput.value = '';
          document.getElementById('chat-container').scrollTop = document.getElementById('chat-container').scrollHeight;
          // Stop typing
          isTyping = false;
          updateTypingStatus(false);
        })
        .catch(error => console.error('Error sending message:', error));
      }
    });

    // Typing status
    document.getElementById('chat-input').addEventListener('input', function() {
      if (!isTyping) {
        isTyping = true;
        updateTypingStatus(true);
      }
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(function() {
        isTyping = false;
        updateTypingStatus(false);
      }, 3000); // Stop typing after 3 seconds of inactivity
    });

    function updateTypingStatus(isTyping) {
      fetch(`/api/typing/${otherUserId}/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ is_typing: isTyping })
      })
      .catch(error => console.error('Error updating typing status:', error));
    }

    // Emoji picker
    const emojiButton = document.getElementById('emoji-button');
    const emojiPicker = document.getElementById('emoji-picker');

    emojiButton.addEventListener('click', function() {
      emojiPicker.style.display = emojiPicker.style.display === 'none' ? 'block' : 'none';
    });

    emojiPicker.addEventListener('emoji-click', function(event) {
      document.getElementById('chat-input').value += event.detail.unicode;
      emojiPicker.style.display = 'none';
      document.getElementById('chat-input').focus();
      document.getElementById('chat-input').dispatchEvent(new Event('input'));
    });

    // Auto-scroll to bottom
    document.querySelector('.chat-container').scrollTop = document.querySelector('.chat-container').scrollHeight;
  </script>
</body>
</html>
