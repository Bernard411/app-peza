{% load static %}
<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Map - Peza Safety App</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Maria Font -->
  <link href="https://fonts.cdnfonts.com/css/maria-2" rel="stylesheet">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <!-- Leaflet Routing Machine CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#000000',
            secondary: '#FFFFFF',
            accent: '#AAAAAA',
            surface: '#000000',
            'surface-light': '#1A1A1A',
            'text-primary': '#FFFFFF',
            'text-secondary': '#CCCCCC',
            'border-light': '#333333',
            'alert-high': '#FF4444',
            'alert-medium': '#FFAA00',
            'alert-low': '#44B4FF'
          }
        }
      }
    }
  </script>
  <style>
    :root {
      --primary: #000000;
      --secondary: #FFFFFF;
      --accent: #AAAAAA;
      --surface: #000000;
      --surface-light: #1A1A1A;
      --text-primary: #FFFFFF;
      --text-secondary: #CCCCCC;
      --border-light: #333333;
      --alert-high: #FF4444;
      --alert-medium: #FFAA00;
      --alert-low: #44B4FF;
      --radius: 10px;
      --shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
    }
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Maria', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--surface);
      margin: 0;
      font-size: 10px;
      overflow: hidden;
      height: 100vh;
      transition: background 0.3s ease;
    }
    body.light {
      --primary: #FFFFFF;
      --secondary: #000000;
      --accent: #666666;
      --surface: #F5F5F7;
      --surface-light: #FFFFFF;
      --text-primary: #000000;
      --text-secondary: #666666;
      --border-light: #E5E5E7;
      background: var(--surface);
    }
    #app-container {
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: transparent;
      overflow: hidden;
    }
    .map-container {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 0;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    .map-container::-webkit-scrollbar {
      display: none;
    }
    #map {
      height: calc(100vh - 108px);
      width: 100%;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .map-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: var(--surface-light);
      border-bottom: 1px solid var(--border-light);
      box-shadow: var(--shadow);
    }
    .map-title {
      font-size: 12px;
      font-weight: 700;
      color: var(--text-primary);
    }
    .map-buttons {
      display: flex;
      gap: 8px;
      padding: 8px 16px;
      background: var(--surface-light);
      border-bottom: 1px solid var(--border-light);
    }
    .btn {
      background: transparent;
      color: var(--text-primary);
      border: 1px solid var(--secondary);
      border-radius: 8px;
      padding: 8px 12px;
      font-weight: 600;
      font-size: 10px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }
    .btn:active {
      transform: scale(0.98);
      background: rgba(255, 255, 255, 0.1);
    }
    .btn-filled {
      background: var(--secondary);
      color: var(--primary);
      border: 1px solid var(--secondary);
    }
    .error-message {
      font-size: 10px;
      color: var(--alert-high);
      text-align: center;
      padding: 16px;
    }
    .theme-toggle {
      position: fixed;
      top: 12px;
      right: 12px;
      z-index: 100;
      background: var(--surface-light);
      border: 1px solid var(--border-light);
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: var(--shadow);
    }
    .theme-toggle svg {
      width: 16px;
      height: 16px;
    }
    .popup {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .popup.active {
      visibility: visible;
      opacity: 1;
    }
    .popup-content {
      background: var(--surface-light);
      border-radius: var(--radius);
      border: 1px solid var(--border-light);
      box-shadow: var(--shadow);
      width: 90%;
      max-width: 320px;
      padding: 16px;
      position: relative;
      max-height: 80vh;
      overflow-y: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    .popup-content::-webkit-scrollbar {
      display: none;
    }
    .popup-close {
      position: absolute;
      top: 8px;
      right: 8px;
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
    }
    .popup-close svg {
      width: 16px;
      height: 16px;
    }
    .popup-title {
      font-size: 12px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
    }
    .popup-text {
      font-size: 10px;
      color: var(--text-primary);
      margin-bottom: 8px;
    }
    .leaflet-routing-container {
      background: var(--surface-light);
      border: 1px solid var(--border-light);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      font-family: 'Maria', sans-serif;
      font-size: 10px;
      color: var(--text-primary);
    }
    .leaflet-routing-container .leaflet-routing-alt {
      color: var(--text-secondary);
    }
    .leaflet-routing-container .leaflet-routing-geocoder {
      background: var(--surface);
      border: 1px solid var(--border-light);
      border-radius: 8px;
      color: var(--text-primary);
    }
    .leaflet-routing-container .leaflet-routing-geocoder input {
      font-size: 10px;
    }
    @media (max-width: 480px) {
      body {
        font-size: 8px;
      }
      #map {
        height: calc(100vh - 88px);
      }
      .map-header {
        padding: 8px 12px;
      }
      .map-title {
        font-size: 10px;
      }
      .map-buttons {
        padding: 6px 12px;
        gap: 6px;
      }
      .btn {
        font-size: 8px;
        padding: 6px 10px;
      }
      .btn svg {
        width: 12px;
        height: 12px;
      }
      .error-message {
        font-size: 8px;
      }
      .theme-toggle {
        width: 28px;
        height: 28px;
        top: 10px;
        right: 10px;
      }
      .theme-toggle svg {
        width: 14px;
        height: 14px;
      }
      .popup-content {
        padding: 12px;
        max-width: 280px;
      }
      .popup-title {
        font-size: 10px;
      }
      .popup-text {
        font-size: 8px;
      }
      .popup-close svg {
        width: 14px;
        height: 14px;
      }
      .leaflet-routing-container {
        font-size: 8px;
      }
      .leaflet-routing-container .leaflet-routing-geocoder input {
        font-size: 8px;
      }
    }
  </style>
</head>
<body>
  <div id="app-container">
    <!-- Theme Toggle -->
    <div class="theme-toggle" onclick="toggleTheme()">
      <svg id="theme-icon" class="w-4 h-4 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
      </svg>
    </div>

    <!-- Map Header -->
    <div class="map-header">
      <button class="btn btn-filled" onclick="window.location.href='{% url 'home' %}'">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Back
      </button>
      <h1 class="map-title" id="map-title">Loading...</h1>
    </div>

    <!-- Map Buttons -->
    <div class="map-buttons">
      <button class="btn btn-filled" onclick="showUserLocation()">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
        Show Your Location
      </button>
      <button class="btn btn-filled" onclick="getDirections()">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
        </svg>
        Directions
      </button>
      <button class="btn btn-filled" onclick="showOtherData()">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        Other Data
      </button>
    </div>

    <!-- Map Container -->
    <div class="map-container">
      <div id="map"></div>
    </div>

    <!-- Other Data Popup -->
    <div id="other-data-popup" class="popup">
      <div class="popup-content">
        <button class="popup-close" onclick="closeOtherDataPopup()">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
        <h3 id="popup-title" class="popup-title"></h3>
        <div class="popup-section">
          <div class="popup-label">Address</div>
          <div id="popup-address" class="popup-text">Loading...</div>
        </div>
        <div class="popup-section">
          <div class="popup-label">Distance</div>
          <div id="popup-distance" class="popup-text">Calculating...</div>
        </div>
      </div>
    </div>
        <!-- Bottom Navigation -->
    {% include 'bottom_nav.html' %}
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <!-- Leaflet Routing Machine JS -->
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
  <script>
    // Apply saved theme on page load
    document.addEventListener('DOMContentLoaded', function() {
      const savedTheme = localStorage.getItem('safetyAppTheme');
      const body = document.body;
      const themeIcon = document.getElementById('theme-icon');
      
      if (savedTheme === 'light') {
        body.classList.add('light');
        themeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />';
      } else {
        body.classList.remove('light');
        themeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />';
      }
    });

    // Theme toggle
    function toggleTheme() {
      const body = document.body;
      const themeIcon = document.getElementById('theme-icon');
      
      if (body.classList.contains('light')) {
        body.classList.remove('light');
        themeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />';
        localStorage.setItem('safetyAppTheme', 'dark');
      } else {
        body.classList.add('light');
        themeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />';
        localStorage.setItem('safetyAppTheme', 'light');
      }
    }

    // Parse query parameters
    const urlParams = new URLSearchParams(window.location.search);
    const lat = parseFloat(urlParams.get('lat'));
    const lon = parseFloat(urlParams.get('lon'));
    const name = decodeURIComponent(urlParams.get('name') || 'Location');

    // Initialize map
    const map = L.map('map');
    const defaultCoords = [-13.9626, 33.7741]; // Default: Lilongwe
    const center = (lat && lon && !isNaN(lat) && !isNaN(lon)) ? [lat, lon] : defaultCoords;

    // Set map view
    map.setView(center, 15);

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      maxZoom: 19,
    }).addTo(map);

    // Add marker for selected location
    let locationMarker = null;
    if (lat && lon && !isNaN(lat) && !isNaN(lon)) {
      locationMarker = L.marker([lat, lon]).addTo(map)
        .bindPopup(`<b>${name}</b>`).openPopup();
      document.getElementById('map-title').textContent = name;
      document.getElementById('popup-title').textContent = name;
    } else {
      document.getElementById('map-title').textContent = 'Invalid Location';
      document.getElementById('map').innerHTML = '<div class="error-message">Invalid or missing coordinates. Please select a valid location.</div>';
    }

    // Initialize routing control
    let routingControl = null;

    // Show user location
    let userMarker = null;
    async function showUserLocation() {
      try {
        const position = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 10000 });
        });
        const userLat = position.coords.latitude;
        const userLon = position.coords.longitude;

        if (userMarker) {
          map.removeLayer(userMarker);
        }
        userMarker = L.marker([userLat, userLon], {
          icon: L.divIcon({
            className: 'user-location',
            html: '<div style="background: #44B4FF; width: 12px; height: 12px; border-radius: 50%; border: 2px solid #FFFFFF;"></div>',
            iconSize: [12, 12],
            iconAnchor: [6, 6]
          })
        }).addTo(map).bindPopup('Your Location').openPopup();

        map.panTo([userLat, userLon]);
      } catch (error) {
        alert('Unable to get your location. Please check location permissions.');
      }
    }

    // Get directions
    async function getDirections() {
      if (!lat || !lon || isNaN(lat) || isNaN(lon)) {
        alert('Invalid destination coordinates.');
        return;
      }
      try {
        const position = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 10000 });
        });
        const userLat = position.coords.latitude;
        const userLon = position.coords.longitude;

        if (routingControl) {
          map.removeControl(routingControl);
        }
        routingControl = L.Routing.control({
          waypoints: [
            L.latLng(userLat, userLon),
            L.latLng(lat, lon)
          ],
          router: L.Routing.osrmv1({
            serviceUrl: 'http://router.project-osrm.org/route/v1'
          }),
          lineOptions: {
            styles: [{ color: '#44B4FF', weight: 5 }]
          },
          addWaypoints: false,
          fitSelectedRoutes: true,
          showAlternatives: false,
          containerClassName: 'leaflet-routing-container'
        }).addTo(map);
      } catch (error) {
        alert('Unable to get your location for routing. Please check location permissions.');
      }
    }

    // Show other data
    async function showOtherData() {
      if (!lat || !lon || isNaN(lat) || isNaN(lon)) {
        alert('Invalid location data.');
        return;
      }
      const popup = document.getElementById('other-data-popup');
      const addressElement = document.getElementById('popup-address');
      const distanceElement = document.getElementById('popup-distance');

      try {
        const position = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 10000 });
        });
        const userLat = position.coords.latitude;
        const userLon = position.coords.longitude;

        const response = await fetch(`/api/peza/?lat=${userLat}&lon=${userLon}&category=ambulance`);
        const data = await response.json();

        if (data.error || !data.locations) {
          addressElement.textContent = 'Unknown Address';
          distanceElement.textContent = 'Unable to calculate distance';
        } else {
          const location = data.locations.find(loc => 
            Math.abs(parseFloat(loc.lat) - lat) < 0.0001 && Math.abs(parseFloat(loc.lon) - lon) < 0.0001
          );
          addressElement.textContent = location ? location.address : 'Unknown Address';
          distanceElement.textContent = location ? location.distance : calculateDistance(userLat, userLon, lat, lon);
        }
      } catch (error) {
        addressElement.textContent = 'Unknown Address';
        distanceElement.textContent = calculateDistance(defaultCoords[0], defaultCoords[1], lat, lon);
      }

      popup.classList.add('active');
    }

    function closeOtherDataPopup() {
      document.getElementById('other-data-popup').classList.remove('active');
    }

    // Calculate distance (Haversine formula)
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371; // Earth's radius in km
      const dlat = (lat2 - lat1) * Math.PI / 180;
      const dlon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dlat/2)**2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dlon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      const distance = R * c;
      return `${distance.toFixed(1)} km`;
    }
  </script>
</body>
</html>